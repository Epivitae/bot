name: Check Email

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

# âš ï¸ å…³é”®ï¼šèµ‹äºˆå†™æƒé™ï¼Œå…è®¸å›å†™ UID æ–‡ä»¶
permissions:
  contents: write

jobs:
  check-mail:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # å¼€å¯ç¼“å­˜ (éœ€è¦ requirements.txt)
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip' 
          cache-dependency-path: python/requirements.txt

      - name: Install dependencies
        run: pip install -r python/requirements.txt

      - name: Run script
        env:
          ION_MAIL_SECRET: ${{ secrets.ION_MAIL }}
        run: python python/email-monitor.py

      # ğŸ‘‡ å›å†™é€»è¾‘ï¼šå¦‚æœæœ‰æ–°é‚®ä»¶ï¼Œseen_uids.txt ä¼šå˜ï¼Œæˆ‘ä»¬å°±æäº¤å®ƒ
      - name: Commit and Push changes
        run: |
          git config --global user.name 'Email Bot'
          git config --global user.email 'bot@noreply.github.com'
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
          if [[ -n $(git status -s python/seen_uids.txt) ]]; then
            echo "ğŸ“„ UID æ–‡ä»¶æœ‰æ›´æ–°ï¼Œæ­£åœ¨æäº¤..."
            git add python/seen_uids.txt
            git commit -m "Update seen UIDs [skip ci]"
            git push
          else
            echo "ğŸ‘ æ²¡æœ‰æ–°é‚®ä»¶ï¼Œæ— éœ€æäº¤ã€‚"
          fi